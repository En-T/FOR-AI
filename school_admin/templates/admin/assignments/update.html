{% extends 'school_admin/base.html' %}

{% block title %}Редактирование назначения{% endblock %}

{% block content %}
<h1 class="h3 mb-3">Редактирование назначения</h1>

<div class="mb-3">
  <a class="btn btn-link" href="{% url 'school_admin:class_detail' pk=school_class.pk %}">← Назад к классу</a>
</div>

<form method="post" class="card card-body">
  {% csrf_token %}

  <h2 class="h5">Параметры</h2>
  {{ assignment_form.as_p }}

  {% if needs_subgroups %}
    <hr>
    <h2 class="h5">Распределение учащихся по подгруппам</h2>
    <p class="text-muted">Переместите учащихся в подгруппу текущего учителя. Учащийся не может быть в двух подгруппах одного предмета.</p>

    {% with selected_ids=students_form.students.value %}
    <div class="row g-3">
      <div class="col-md-5">
        <div class="form-label">Все учащиеся класса</div>
        <select id="availableStudents" class="form-select" size="14" multiple>
          {% for s in students_form.fields.students.queryset %}
            {% if selected_ids and s.pk|stringformat:'s' in selected_ids %}{% else %}
              <option value="{{ s.pk }}">{{ s.full_name }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-flex flex-column justify-content-center gap-2">
        <button class="btn btn-outline-primary" type="button" id="btnAdd">→</button>
        <button class="btn btn-outline-primary" type="button" id="btnRemove">←</button>
      </div>
      <div class="col-md-5">
        <div class="form-label">Подгруппа текущего учителя</div>
        <select id="selectedStudents" class="form-select" size="14" multiple>
          {% for s in students_form.fields.students.queryset %}
            {% if selected_ids and s.pk|stringformat:'s' in selected_ids %}
              <option value="{{ s.pk }}">{{ s.full_name }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <select id="hiddenStudents" name="students" multiple hidden></select>
      </div>
    </div>
    {% endwith %}
  {% else %}
    <hr>
    <div class="alert alert-info">Назначение действует для всего класса (подгруппы не используются).</div>
  {% endif %}

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary" type="submit">Сохранить</button>
    <a class="btn btn-outline-danger" href="{% url 'school_admin:assignment_delete' pk=school_class.pk assignment_id=assignment.pk %}">Удалить назначение</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const available = document.getElementById('availableStudents');
  const selected = document.getElementById('selectedStudents');
  const hidden = document.getElementById('hiddenStudents');
  const btnAdd = document.getElementById('btnAdd');
  const btnRemove = document.getElementById('btnRemove');

  if (!available || !selected || !hidden) return;

  function move(from, to) {
    Array.from(from.selectedOptions).forEach(opt => {
      to.appendChild(opt);
    });
  }

  btnAdd && btnAdd.addEventListener('click', () => move(available, selected));
  btnRemove && btnRemove.addEventListener('click', () => move(selected, available));

  document.querySelector('form').addEventListener('submit', () => {
    hidden.innerHTML = '';
    Array.from(selected.options).forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value;
      o.selected = true;
      hidden.appendChild(o);
    });
  });
})();
</script>
{% endblock %}
